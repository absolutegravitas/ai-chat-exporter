name: Release Builder

on:
  push:
    branches:
      - main
      - feature/**
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./manifest.json').version" 2>/dev/null || echo "4.0.0")
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION="${BASE_VERSION}-${TIMESTAMP}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create zip
        run: |
          zip -r ai-chat-exporter-v${{ steps.version.outputs.version }}.zip \
            manifest.json \
            popup.html \
            popup.js \
            src/ \
            icons/ \
            LICENSE \
            README.md \
            extension_description_v4.0.2.txt

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          gh release create "$TAG" \
            --title "$TAG" \
            --notes "Auto-generated release from latest push"

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ZIPFILE="ai-chat-exporter-v${{ steps.version.outputs.version }}.zip"
          gh release upload "$TAG" "$ZIPFILE"
